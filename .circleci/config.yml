version: 2
jobs:
  build:
    machine:
      image: circleci/classic:edge
    environment:
      RAILS_ENV: test
      NODE_ENV: test
    steps:
      - checkout
      - run:
          name: update docker-compose
          command: pip install docker-compose==1.22.0
      - run:
          name: check docker-compose version
          command: docker-compose --version
      - restore_cache:
          keys:
            - v3-test-{{ checksum "Dockerfile" }}
          paths:
            - ~/caches/images.tar
      - run:
          name: docker load or build
          command: |
            if [[ -e ~/caches/images.tar ]]; then
              docker load -i ~/caches/images.tar
            else
              docker-compose -p docker_rails_sample build
            fi
      - run:
          name: docker-compose build
          command: docker-compose -p docker_rails_sample build
      - run:
          name: docker save
          command: |
            mkdir -p ~/caches
            if [[ ! -e ~/caches/images.tar ]]; then
              docker save -o ~/caches/images.tar $(docker images --filter "dangling=false" --format "docker_rails_sample_rails:latest")
            fi
      - save_cache:
          key: v3-test-{{ checksum "Dockerfile" }}
          paths:
            - ~/caches/images.tar
      - run:
          name: docker-compose -p docker_rails_sample run --rm rails bundle install
          command: docker-compose -p docker_rails_sample run --rm rails bundle install
      - run:
          name: docker-compose -p docker_rails_sample run --rm webpack yarn install
          command: docker-compose -p docker_rails_sample run --rm webpack yarn install
      - run:
          name: docker-compose up
          command: docker-compose -p docker_rails_sample up -d
      - run:
          name: docker exec docker_rails_sample_rails_1 bundle exec rake assets:precompile
          command: docker exec docker_rails_sample_rails_1 bundle exec rake assets:precompile
      - run:
          name: docker exec docker_rails_sample_rails_1 bin/setup
          command: docker exec docker_rails_sample_rails_1 bin/setup
      - run:
          name: test
          command: docker exec docker_rails_sample_rails_1 bundle exec rspec spec
      - run:
          name: docker-compose down
          command: docker-compose down
      - run:
          name: docker save
          command: |
            mkdir -p ~/caches
            if [[ ! -e ~/caches/images.tar ]]; then
              docker save -o ~/caches/images.tar $(docker images --filter "dangling=false" --format "docker_rails_sample_rails:latest")
            fi
workflows:
  version: 2
  build:
    jobs:
      - build
